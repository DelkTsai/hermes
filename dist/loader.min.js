!function(t){"use strict";var e={getType:function(t){return Object.prototype.toString.call(t)},proxy:function(t,e){return t?function(){return t.apply(e||this,arguments)}:void 0},forEach:function(t,e){if(t)if(t.forEach)t.forEach.call(t,e);else{var n=this.getType(t);if("[object Array]"===n){for(var o=0;o<t.length;o++)if(e.call(t[o],t[o],o)===!1)return}else if("[object Object]"===n)for(var o in t)if(t.hasOwnProperty(o)&&e.call(t[o],t[o],o)===!1)return}},uuid:function(){for(var t=[],e="0123456789ABCDEF",n=0;36>n;n++)t[n]=e.substr(Math.floor(16*Math.random()),1);t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-";var o=t.join("");return o},extend:function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},ajax:function(e){var n=null;if(t.XMLHttpRequest)n=new t.XMLHttpRequest;else if(t.ActiveXObject)try{n=new t.ActiveXObject("Msxml2.XMLHTTP")}catch(o){n=new t.ActiveXObjec("Microsoft.XMLHTTP")}if(null!==n){e=this.extend({method:"GET",url:null,data:null,isAsync:!0,success:null,error:null},e);var r="";"GET"===e.method&&"[object Object]"===this.getType(e.data)&&(this.forEach(e.data,function(e,n){r+=n+"="+t.encodeURIComponent(e)+"&"}),r=r.substr(0,r.length-1),e.url+=e.url.indexOf("?")>=0?"&"+r:"?"+r),n.open(e.method,e.url,e.isAsync),"GET"===e.method?n.send(null):"POST"===e.method&&n.send(r),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?e.success&&e.success(n.responseText):e.error&&e.error())}}},addEvent:function a(){return document.addEventListener?function(t,e,n){if(t.length)for(var o=0;o<t.length;o++)a(t[o],e,n);else t.addEventListener(e,n,!1)}:function(e,n,o){if(e.length)for(var r=0;r<e.length;r++)a(e[r],n,o);else e.attachEvent("on"+n,function(n){return o.call(e,n||t.event)})}}(),isDocument:function(t){return null!=t&&t.nodeType==t.DOCUMENT_NODE},qsa:function(t,n){var o,r="#"==n[0],s=!r&&"."==n[0],i=r||s?n.slice(1):n,a=/^[\w-]*$/.test(i);return e.isDocument(t)&&a&&r?(o=t.getElementById(i))?[o]:[]:1!==t.nodeType&&9!==t.nodeType?[]:Array.prototype.slice.call(a&&!r?s?t.getElementsByClassName(i):t.getElementsByTagName(n):t.querySelectorAll(n))},matches:function(t,n){if(!n||!t||1!==t.nodeType)return!1;var o=t.webkitMatchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.oMatchesSelector||t.matchesSelector;if(o)return o.call(t,n);var r,s=t.parentNode,i=document.createElement("div"),a=!s;return a&&(s=i).appendChild(t),r=~e.qsa(s,n).indexOf(t),a&&i.removeChild(t),r}},n={ProcessStatus:{NOSTART:0,RUNNING:1,PAUSE:2,COMPLETE:3,ERROR:4},ProcessCommand:{PAUSE:0,STOP:1,NONE:2},FileStatus:{NOSTART:0,RUNNING:1,ERROR:2,COMPLETE:3}},o=function(t){this.conf=e.extend({},t),this.handler={onComplete:null,onError:null},this._file={},this._status=n.FileStatus.NOSTART;var o=navigator.userAgent;this._isIE=o.indexOf("MSIE")>=0,this._body=document.body||document.getElementsByTagName("body")[0]};o.prototype={constructor:o,_onload:function(){this._status=n.FileStatus.COMPLETE,this.runHandler(this.handler.onComplete,this._file)},_onerror:function(){this._status=n.FileStatus.ERROR,this.runHandler(this.handler.onError,this._file)},status:function(){var t=arguments[0];return void 0===t?this._status:void(this._status=t)},process:function(t){if(this._file=t,this._file.url){var o=null;return this._status=n.FileStatus.RUNNING,this._isIE?(o=new Image,o.src=this._file.url,o.onload=e.proxy(this._onload,this),o.onerror=e.proxy(this._onerror,this)):(o=document.createElement("object"),o.data=this._file.url,o.width=0,o.height=0,o.onload=e.proxy(this._onload,this),o.onerror=e.proxy(this._onerror,this),this._body.appendChild(o)),this}},bind:function(t,e){return this.handler[t]=e,this},runHandler:function(t,e){return t&&t(e),this}};var r=function(t){this.conf=e.extend({},t),this._cache=[],this._complete=[],this.handler={onItemComplete:null,onItemStart:null,onItemError:null,onComplete:null,onStart:null,onError:null,onPause:null}};r.prototype={constructor:r,_createLoader:function(){var t=new o;return t.bind("onComplete",e.proxy(this._onItemComplete,this)).bind("onError",e.proxy(this._onItemError,this))},_getLoader:function(){for(var t=null,e=0;e<this._cache.length;e++){var o=this._cache[e];if(o.status()!==n.FileStatus.RUNNING){t=o;break}}return null===t&&(t=this._createLoader(),this._cache.push(t)),t},_onItemComplete:function(t){this.runHandler(this.handler.onItemComplete,t.url),this._complete.push(t),this._toComplete(),this._toContinue(),this._toPause()},_onItemError:function(t){this.runHandler(this.handler.onItemError,t.url).runHandler(this.handler.onError,t),this._toComplete(),this._toContinue(),this._toPause()},_toComplete:function(){return 0===this._queue.length&&this._status!==n.ProcessStatus.COMPLETE?(this._status=n.ProcessStatus.COMPLETE,this.runHandler(this.handler.onComplete),!0):!1},_toContinue:function(){this._status!==n.ProcessStatus.COMPLETE&&this._command==n.ProcessCommand.NONE&&this._process({queue:this._queue})},_toPause:function(){this._command===n.ProcessCommand.PAUSE&&this._status===n.ProcessStatus.RUNNING&&(this._status=n.ProcessStatus.PAUSE,this.runHandler(this.handler.onPause))},_process:function(){if(this._queue&&(this._command=n.ProcessCommand.NONE,this._status=n.ProcessStatus.RUNNING,!this._toComplete()&&this._queue.length>0)){var t=this._getLoader();if(null!==t){var e=this._queue.pop();e&&(this.runHandler(this.handler.onItemStart,e.uri),t.process({url:e.uri,type:e.type}))}}},process:function(t){return this._queue=t.queue,this.runHandler(this.handler.onStart),this._process(),this},pause:function(){return this._command=n.ProcessCommand.PAUSE,this},goOn:function(){return this._process({queue:this._queue}),this},bind:function(t,e){return this.handler[t]=e,this},runHandler:function(t,e){return t&&t(e),this}};var s={load:function(n){var o=n.resources||null;if(null===o||!o.length)return void console.warn("依赖资源列表为空，本次将不预加载任何内容！");var s={},i=new r,a=e.uuid();i.bind("onStart",function(){console.log("开始下载")}).bind("onItemStart",function(t){var e=new Date,n=e.getTime();s[t]={},s[t].startTime=n}).bind("onItemComplete",function(n){var o=new Date,r=o.getTime();s[n]&&(s[n].endTime=r),console.log("资源 "+n+"下载完成！"),e.ajax({method:"GET",url:"http://labs.qiang.it/tools/hermes/api.php",data:{act:"reportLoad",page:t.encodeURIComponent(t.location.href),resourceUrl:t.encodeURIComponent(n),isLoaded:1,flag:a,startTime:s[n].startTime,endTime:s[n].endTime}})}).bind("onItemError",function(n){e.ajax({method:"GET",url:"http://labs.qiang.it/tools/hermes/api.php",data:{act:"reportLoad",page:t.encodeURIComponent(t.location.href),resourceUrl:t.encodeURIComponent(n),isLoaded:0,flag:a,startTime:s[n].startTime,endTime:s[n].endTime}})}).bind("onComplete",function(){console.log(s)}).process({queue:o})}};t.onload=function(){e.ajax({method:"GET",url:"http://labs.qiang.it/tools/hermes/api.php",data:{act:"getResourceList",uri:t.encodeURIComponent(t.location.href)},success:function(t){try{t=JSON.parse(t)}catch(e){t={errCode:1}}0===t.errCode&&s.load(t.data)}})};var i={bind:function(){e.addEvent(document,"click",function(n){for(var o=n.target||n.srcElement,r=e.qsa(document,"a");o&&!(r?r.indexOf(o)>=0:e.matches(o,selector));)o=o!==document&&!e.isDocument(o)&&o.parentNode;if(o!==!1&&"a"===o.tagName.toLocaleLowerCase()){var s=o.getAttribute("href"),i=/^(http[s]?:\/\/(www\.)?|ftp:\/\/(www\.)?|www\.){1}([0-9A-Za-z-\.@:%_+~#=]+)+((\.[a-zA-Z]{2,3})+)(\/(.)*)?(\?(.)*)?/;if(!(!s||!i.test(s)&&!s.indexOf("/")>=0)){s=t.encodeURIComponent(s);var a=t.encodeURIComponent(t.location.href),u=t.encodeURIComponent(document.title),l=new Image;l.src="http://labs.qiang.it/tools/hermes/api.php?act=reportClick&page="+a+"&description="+u+"&goto="+s}}})}};i.bind()}(window);